name: Release Tools

on:
  push:
    tags:
      - 'tools-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Tools version (e.g., 1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    name: Create Tools Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/tools-v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat > release_notes.md << 'NOTES'
          SAS Tools v${{ steps.get_version.outputs.version }}

          ## Tools Included

          - **Map Editor** - Create and edit game maps
          - **NavGraph Generator** - Generate navigation graphs for bots
          - **Dedicated Server** - Run headless game server

          ## Installation

          Download the archive for your platform and extract it.

          ## Usage

          **Map Editor:**
          ```bash
          ./map_editor
          ```

          **NavGraph Generator:**
          ```bash
          ./generate_navgraph <map_file>
          ```

          **Dedicated Server:**
          ```bash
          ./dedicated_server
          ```
          NOTES
          
          gh release create tools-v${{ steps.get_version.outputs.version }} \
            --repo ${{ github.repository }} \
            --title "SAS Tools v${{ steps.get_version.outputs.version }}" \
            --notes-file release_notes.md

  build-macos:
    name: Build Tools macOS
    needs: create-release
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - x86_64-apple-darwin
          - aarch64-apple-darwin
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true

      - name: Build Tools
        run: |
          cargo build --release --target ${{ matrix.target }} --bin map_editor
          cargo build --release --target ${{ matrix.target }} --bin generate_navgraph
          cargo build --release --target ${{ matrix.target }} --bin dedicated_server

      - name: Create package
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          ARCH=$(echo ${{ matrix.target }} | cut -d'-' -f1)
          PACKAGE_NAME="sas-tools-${VERSION}-macos-${ARCH}"
          
          mkdir -p "$PACKAGE_NAME"
          cp "target/${{ matrix.target }}/release/map_editor" "$PACKAGE_NAME/"
          cp "target/${{ matrix.target }}/release/generate_navgraph" "$PACKAGE_NAME/"
          cp "target/${{ matrix.target }}/release/dedicated_server" "$PACKAGE_NAME/"
          
          tar -czf "${PACKAGE_NAME}.tar.gz" "$PACKAGE_NAME"

      - name: Upload Release Asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          ARCH=$(echo ${{ matrix.target }} | cut -d'-' -f1)
          gh release upload tools-v${VERSION} \
            sas-tools-${VERSION}-macos-${ARCH}.tar.gz \
            --repo ${{ github.repository }} \
            --clobber

  build-linux:
    name: Build Tools Linux
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libudev-dev pkg-config

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build Tools
        run: |
          cargo build --release --bin map_editor
          cargo build --release --bin generate_navgraph
          cargo build --release --bin dedicated_server

      - name: Create package
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          PACKAGE_NAME="sas-tools-${VERSION}-linux-x86_64"
          
          mkdir -p "$PACKAGE_NAME"
          cp "target/release/map_editor" "$PACKAGE_NAME/"
          cp "target/release/generate_navgraph" "$PACKAGE_NAME/"
          cp "target/release/dedicated_server" "$PACKAGE_NAME/"
          
          tar -czf "${PACKAGE_NAME}.tar.gz" "$PACKAGE_NAME"

      - name: Upload Release Asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload tools-v${{ needs.create-release.outputs.version }} \
            sas-tools-${{ needs.create-release.outputs.version }}-linux-x86_64.tar.gz \
            --repo ${{ github.repository }} \
            --clobber

  build-windows:
    name: Build Tools Windows
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build Tools
        run: |
          cargo build --release --bin map_editor
          cargo build --release --bin generate_navgraph
          cargo build --release --bin dedicated_server

      - name: Create package
        shell: bash
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          PACKAGE_NAME="sas-tools-${VERSION}-windows-x86_64"
          
          mkdir -p "$PACKAGE_NAME"
          cp "target/release/map_editor.exe" "$PACKAGE_NAME/"
          cp "target/release/generate_navgraph.exe" "$PACKAGE_NAME/"
          cp "target/release/dedicated_server.exe" "$PACKAGE_NAME/"
          
          7z a -tzip "${PACKAGE_NAME}.zip" "$PACKAGE_NAME"

      - name: Upload Release Asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload tools-v${{ needs.create-release.outputs.version }} \
            sas-tools-${{ needs.create-release.outputs.version }}-windows-x86_64.zip \
            --repo ${{ github.repository }} \
            --clobber





